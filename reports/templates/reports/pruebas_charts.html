{% extends 'reports/base.html' %} {% load static %} {% block content %}

<h2>Últimas cargas de sal</h2>
<ul id="charge-list">
  <li>Cargando datos...</li>
</ul>

<!-- Chart de humedad conectado al API -->

<div class="responsive-container">
  <div>
    <h3>Humedad por carga</h3>
    <canvas id="humidityChart"></canvas>
  </div>

  <div>
    <h3>Peso por carga</h3>
    <canvas id="weightLineChart"></canvas>
  </div>

  <div>
    <h3>Peso de entrada</h3>
    <canvas id="weightPieEntrada"></canvas>
  </div>

  <div>
    <h3>Peso de salida</h3>
    <canvas id="weightPieSalida"></canvas>
  </div>

  <!-- Temperatura -->
  <div>
    <h3>Temperatura Entrada y Salida (°C)</h3>
    <canvas id="tempChart" ></canvas>
  </div>

  <!-- Peso -->
  <div>
    <h3>Peso Entrada y Salida (kg)</h3>
    <canvas id="pesoChart"></canvas>
  </div>

  <!-- Humedad -->
  <div>
    <h3>Humedad Entrada y Salida (%)</h3>
    <canvas id="humedadChart"></canvas>
  </div>
</div>


  <script src="{% static 'js/chart.js' %}"></script>
  <script>
    const labelsHumidity = [];
    const humidityStartData = [];
    const humidityEndData = [];

    document.addEventListener("DOMContentLoaded", function () {
      fetch("http://127.0.0.1:8001/api/charges/")
        .then((response) => {
          if (!response.ok)
            throw new Error("Error en la respuesta del servidor");
          return response.json();
        })
        .then((data) => {
          const list = document.getElementById("charge-list");
          list.innerHTML = "";

          if (data.length === 0) {
            list.innerHTML = "<li>No hay cargas registradas.</li>";
            return;
          }

          const last15 = data.slice(-15);

          last15.forEach((charge) => {
            const id = charge.id;
            const startTime = new Date(
              charge.charge_time_start
            ).toLocaleTimeString("es-MX", {
              hour: "2-digit",
              minute: "2-digit",
            });
            const endTime = new Date(
              charge.charge_time_finish
            ).toLocaleTimeString("es-MX", {
              hour: "2-digit",
              minute: "2-digit",
            });

            labelsHumidity.push(`#${id}`);
            humidityStartData.push(charge.charge_humidity_start);
            humidityEndData.push(charge.charge_humidity_finish);

            const item = document.createElement("li");
            item.textContent = `#${id} | ${startTime} - ${endTime} | Entrada: ${charge.charge_weight_start} kg – ${charge.charge_humidity_start}% humedad`;
            list.appendChild(item);
          });

          renderHumidityChart();
          renderWeightChart(); // también se ejecuta, pero usa datos fijos
          renderWeightPieCharts();
        })
        .catch((error) => {
          document.getElementById(
            "charge-list"
          ).innerHTML = `<li>Error: ${error.message}</li>`;
          console.error("Error al obtener datos:", error);
        });

      function renderHumidityChart() {
        const ctx = document.getElementById("humidityChart").getContext("2d");
        new Chart(ctx, {
          type: "bar",
          data: {
            labels: labelsHumidity,
            datasets: [
              {
                label: "Humedad de entrada (%)",
                data: humidityStartData,
                backgroundColor: "rgba(54, 162, 235, 0.7)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 1,
              },
              {
                label: "Humedad de salida (%)",
                data: humidityEndData,
                backgroundColor: "rgba(255, 99, 132, 0.7)",
                borderColor: "rgba(255, 99, 132, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
              position: "bottom",
            },
              title: {
                display: true,
                text: "Comparativa de humedad por carga",
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 20,
              },
            },
          },
        });
      }

      // INTERFAZ DE PRUEBA PARA LA GRAFICA DE PESO ---------------------------------------------------------
      function renderWeightChart() {
        const labels = Array.from({ length: 9 }, (_, i) => `No. # ${i + 1}`);
        const weightStart = [
          2000, 1980, 2020, 1950, 2050, 2100, 2005, 1995, 2010,
        ];
        const weightFinish = [
          1500, 1480, 1510, 1450, 1490, 1530, 1495, 1475, 1505,
        ];

        const ctx = document.getElementById("weightLineChart").getContext("2d");

        new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Peso Entrada (kg)",
                data: weightStart,
                borderColor: "rgba(54, 162, 235, 1)",
                backgroundColor: "blue",
                tension: 0.3,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6,
              },
              {
                label: "Peso Salida (kg)",
                data: weightFinish,
                borderColor: "rgba(255, 99, 132, 1)",
                backgroundColor: "red",
                tension: 0.3,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6,
              },
            ],
          },
          options: {
            responsive: false,
            plugins: {
              legend: {
              position: "bottom",
            },
              title: {
                display: true,
                text: "Peso registrado en las ultimas cargas",
                font: {
                  size: 18,
                },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Kilogramos (kg)",
                },
              },
              x: {
                title: {
                  display: true,
                  text: "Cargas recientes",
                },
              },
            },
          },
        });
      }
    });

    //JS Para poblar la tabla (lo movi a todo el js mejor para que no se repitan etiquetas)

    document.addEventListener("DOMContentLoaded", function () {
      const tableBody = document.querySelector("#charge-table tbody");

      fetch("http://127.0.0.1:8001/api/charges/")
        .then((response) => {
          if (!response.ok)
            throw new Error("Error al obtener los datos del servidor");
          return response.json();
        })
        .then((data) => {
          tableBody.innerHTML = "";

          if (data.length === 0) {
            tableBody.innerHTML =
              '<tr><td colspan="9">No hay cargas registradas.</td></tr>';
            return;
          }

          data.forEach((charge) => {
            const row = document.createElement("tr");

            const timeStart = new Date(charge.charge_time_start).toLocaleString(
              "es-MX"
            );
            const timeFinish = new Date(
              charge.charge_time_finish
            ).toLocaleString("es-MX");

            row.innerHTML = `
            <td>${timeStart}</td>
            <td>${timeFinish}</td>
            <td>${charge.charge_weight_start}</td>
            <td>${charge.charge_weight_finish}</td>
            <td>${charge.charge_humidity_start}</td>
            <td>${charge.charge_humidity_finish}</td>
            <td>${charge.charge_temperature_start}</td>
            <td>${charge.charge_temperature_finish}</td>
          `;

            tableBody.appendChild(row);
          });
        })
        .catch((error) => {
          tableBody.innerHTML = `<tr><td colspan="9">Error: ${error.message}</td></tr>`;
          console.error("Error al obtener los datos:", error);
        });
    });
  
    function renderWeightPieCharts() {
      const labels = Array.from({ length: 9 }, (_, i) => `No. # ${i + 1}`);
      const weightStartPie = [
        2000, 1980, 2020, 1950, 2050, 2100, 2005, 1995, 2010,
      ];
      const weightFinishPie = [
        1500, 1480, 1510, 1450, 1490, 1530, 1495, 1475, 1505,
      ];

      const ctxEntrada = document
        .getElementById("weightPieEntrada")
        .getContext("2d");
      const ctxSalida = document
        .getElementById("weightPieSalida")
        .getContext("2d");

      new Chart(ctxEntrada, {
        type: "pie",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Peso de entrada (kg)",
              data: weightStartPie,
              backgroundColor: labels.map(
                () => `hsl(${Math.random() * 360}, 70%, 60%)`
              ),
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: "bottom",
            },
            title: {
              display: true,
              text: "Peso de entrada por carga",
            },
          },
        },
      });

      new Chart(ctxSalida, {
        type: "pie",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Peso de salida (kg)",
              data: weightFinishPie,
              backgroundColor: labels.map(
                () => `hsl(${Math.random() * 360}, 70%, 60%)`
              ),
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: "bottom",
            },
            title: {
              display: true,
              text: "Peso de salida por carga",
            },
          },
        },
      });
    }
  
    // Simulación de datos para una carga
    const carga = {
      tempStart: 65,
      tempEnd: 40,
      pesoStart: 2000,
      pesoEnd: 1500,
      humedadStart: 15,
      humedadEnd: 5,
    };

    // Configuración base para cada donut
    function crearDonut(idCanvas, labels, data, colores, titulo) {
      new Chart(document.getElementById(idCanvas), {
        type: "doughnut",
        data: {
          labels: labels,
          datasets: [
            {
              data: data,
              backgroundColor: colores,
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: "bottom",
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  return `${context.label}: ${context.raw}`;
                },
              },
            },
          },
          cutout: "60%",
        },
      });
    }

    // Crear las 3 gráficas
    crearDonut(
      "tempChart",
      ["Entrada (°C)", "Salida (°C)"],
      [carga.tempStart, carga.tempEnd],
      ["#ff9800", "#03a9f4"]
      
    );

    crearDonut(
      "pesoChart",
      ["Entrada (kg)", "Salida (kg)"],
      [carga.pesoStart, carga.pesoEnd],
      ["#4caf50", "#f44336"]
    );

    crearDonut(
      "humedadChart",
      ["Entrada (%)", "Salida (%)"],
      [carga.humedadStart, carga.humedadEnd],
      ["#9c27b0", "#ffeb3b"]
    );

  </script>



  <!-- Tabla estilizada -->
  <h2>Tabla</h2>
  <hr />
  <div class="table-container">
    <table id="charge-table">
      <thead>
        <tr>
          <th>Inicio</th>
          <th>Fin</th>
          <th>Peso Entrada (kg)</th>
          <th>Peso Salida (kg)</th>
          <th>Humedad Entrada (%)</th>
          <th>Humedad Salida (%)</th>
          <th>Temp. Entrada (°C)</th>
          <th>Temp. Salida (°C)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="9">Cargando datos...</td>
        </tr>
      </tbody>
    </table>
  </div>


  
  <!-- Estilos CSS para la tabla -->

  <style>
    .responsive-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(clamp(300px, 50%, 450px), 1fr));
      gap: 30px;
      padding: 20px;
      align-items: center;
    }

    canvas {
      width: 100% !important;
      height: auto !important;
      max-width: 100% !important;
      margin-top: 20px;
    }

    #charge-list {
      padding-left: 20px;
      margin-bottom: 30px;
    }

    .table-container {
      overflow-x: auto;
      padding: 20px;
      background: #ffffff;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 100%;
      margin: auto;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    h3,
    h2,
    h1 {
      text-align: center;
      font-size: clamp(1.5vw, 2vw + 1rem, 5vw);
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    thead {
      background-color: #db0632;
      color: white;
      text-align: left;
    }

    th,
    td {
      padding: 12px 15px;
      text-align: center;
      white-space: nowrap;
    }

    tr:nth-child(even) {
      background-color: #f8f8f8;
    }

    tr:hover {
      background-color: #800000;
      color: white;
    }

    th {
      font-weight: bold;
    }

    @media (max-width: 768px) {
      .responsive-container {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      table {
        font-size: 0.85em;
      }

      th,
      td {
        padding: 8px;
      }

      h2,
      h3 {
        font-size: 1.1em;
      }
    }
  </style>


</div>

{% endblock %}
