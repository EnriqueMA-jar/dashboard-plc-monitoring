{% extends 'users/base.html' %}
{% block content %}

<h2>Ãšltimas cargas de sal</h2>
<ul id="charge-list">
  <li>Cargando datos...</li>
</ul>

<canvas id="humidityChart" width="600" height="250"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = [];
  const humidityStartData = [];
  const humidityEndData = [];

  document.addEventListener('DOMContentLoaded', function () {
    fetch('http://127.0.0.1:8001/api/charges/')
      .then(response => {
        if (!response.ok) throw new Error('Error en la respuesta del servidor');
        return response.json();
      })
      .then(data => {
        const list = document.getElementById('charge-list');
        list.innerHTML = '';

        if (data.length === 0) {
          list.innerHTML = '<li>No hay cargas registradas.</li>';
        } else {
          data.forEach(charge => {
            const rawDate = new Date(charge.charge_time_start);
            const formatted = rawDate.toLocaleDateString('es-MX');

            labels.push(formatted);
            humidityStartData.push(charge.charge_humidity_start);
            humidityEndData.push(charge.charge_humidity_finish);

            const item = document.createElement('li');
            item.textContent = `#${charge.id} | Inicio: ${formatted} | Entrada: ${charge.charge_weight_start} kg - ${charge.charge_humidity_start}% humedad`;
            list.appendChild(item);
          });

          renderChart(labels, humidityStartData, humidityEndData);
        }
      })
      .catch(error => {
        document.getElementById('charge-list').innerHTML = `<li>Error: ${error.message}</li>`;
        console.error('Error al obtener datos:', error);
      });
  });

  function renderChart(labels, startData, endData) {
    const ctx = document.getElementById('humidityChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Humedad de entrada (%)',
            data: startData,
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          },
          {
            label: 'Humedad de salida (%)',
            data: endData,
            backgroundColor: 'rgba(255, 99, 132, 0.7)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: false,
        plugins: {
          title: {
            display: true,
            text: 'Comparativa de humedad por carga'
          },
          legend: {
            position: 'top'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 20
          }
        }
      }
    });
  }
</script>

{% endblock %}
